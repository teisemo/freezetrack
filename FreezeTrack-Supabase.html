<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a1628">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>FreezeTrack</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-deep: #0a1628;
  --bg-card: #111d33;
  --bg-card-hover: #162440;
  --frost-1: #4fc3f7;
  --frost-2: #81d4fa;
  --frost-3: #b3e5fc;
  --ice-glow: rgba(79, 195, 247, 0.15);
  --warning: #ffb74d;
  --danger: #ef5350;
  --success: #66bb6a;
  --text-primary: #e8f4fd;
  --text-secondary: #7da8c9;
  --text-muted: #4a6d8c;
  --border: rgba(79, 195, 247, 0.12);
  --radius: 16px;
  --radius-sm: 10px;
  --shadow: 0 8px 32px rgba(0,0,0,0.3);
  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'DM Sans', system-ui, sans-serif;
  --fridge-accent: #66bb6a;
  --freezer-accent: #4fc3f7;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; overflow:hidden; }
body { font-family:var(--font-body); background:var(--bg-deep); color:var(--text-primary); overscroll-behavior:none; }

/* ===== FROST BG ===== */
.frost-bg {
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background: radial-gradient(ellipse 600px 400px at 20% 10%, rgba(79,195,247,0.07), transparent),
    radial-gradient(ellipse 500px 500px at 80% 90%, rgba(129,212,250,0.05), transparent), var(--bg-deep);
}

/* ===== AUTH SCREEN ===== */
.auth-screen {
  position:fixed; inset:0; z-index:500;
  display:flex; align-items:center; justify-content:center;
  background:var(--bg-deep); transition:opacity 0.4s;
}
.auth-screen.hidden { opacity:0; pointer-events:none; }
.auth-card {
  width:90%; max-width:380px; padding:36px 28px;
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:24px; text-align:center;
}
.auth-card .logo { font-size:48px; margin-bottom:8px; }
.auth-card h1 {
  font-family:var(--font-display); font-size:28px; font-weight:800;
  background:linear-gradient(135deg,var(--frost-1),var(--frost-3));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  margin-bottom:4px;
}
.auth-card .subtitle { color:var(--text-muted); font-size:13px; margin-bottom:28px; }
.auth-input {
  width:100%; padding:12px 16px; margin-bottom:12px;
  background:var(--bg-deep); border:1px solid var(--border);
  border-radius:var(--radius-sm); color:var(--text-primary);
  font-family:var(--font-body); font-size:15px; outline:none;
  transition:border-color 0.2s;
}
.auth-input:focus { border-color:var(--frost-1); }
.auth-input::placeholder { color:var(--text-muted); }
.auth-btn {
  width:100%; padding:13px; border:none; border-radius:var(--radius-sm);
  background:linear-gradient(135deg,var(--frost-1),#0288d1);
  color:white; font-family:var(--font-body); font-size:15px;
  font-weight:700; cursor:pointer; transition:all 0.2s; margin-top:4px;
}
.auth-btn:active { transform:scale(0.98); }
.auth-btn:disabled { opacity:0.5; cursor:not-allowed; }
.auth-toggle {
  margin-top:16px; font-size:13px; color:var(--text-secondary);
}
.auth-toggle a {
  color:var(--frost-1); cursor:pointer; text-decoration:none; font-weight:600;
}
.auth-error {
  background:rgba(239,83,80,0.12); border:1px solid rgba(239,83,80,0.3);
  border-radius:8px; padding:8px 12px; margin-bottom:12px;
  font-size:12px; color:var(--danger); display:none;
}
.auth-error.show { display:block; }
.auth-success {
  background:rgba(102,187,106,0.12); border:1px solid rgba(102,187,106,0.3);
  border-radius:8px; padding:8px 12px; margin-bottom:12px;
  font-size:12px; color:var(--success); display:none;
}
.auth-success.show { display:block; }

/* ===== SYNC INDICATOR ===== */
.sync-dot {
  width:8px; height:8px; border-radius:50%; flex-shrink:0;
  transition:background 0.3s;
}
.sync-dot.online { background:var(--success); box-shadow:0 0 6px rgba(102,187,106,0.5); }
.sync-dot.syncing { background:var(--warning); animation:pulse 1s infinite; }
.sync-dot.offline { background:var(--danger); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* ===== APP SHELL ===== */
.app {
  position:relative; z-index:1; display:flex; flex-direction:column;
  height:100vh; height:100dvh; max-width:520px; margin:0 auto;
}

/* ===== HEADER ===== */
.header {
  padding:14px 20px 10px; display:flex; align-items:center;
  justify-content:space-between; flex-shrink:0;
}
.header-left { display:flex; align-items:center; gap:8px; }
.header h1 {
  font-family:var(--font-display); font-size:22px; font-weight:800;
  background:linear-gradient(135deg,var(--frost-1),var(--frost-3));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.header-right { display:flex; align-items:center; gap:8px; }
.count-badge {
  background:var(--ice-glow); border:1px solid var(--border);
  border-radius:20px; padding:3px 11px; font-size:11px;
  font-weight:500; color:var(--frost-2);
}
.icon-btn {
  width:32px; height:32px; border-radius:9px;
  background:var(--bg-card); border:1px solid var(--border);
  color:var(--text-secondary); display:flex; align-items:center;
  justify-content:center; cursor:pointer; font-size:14px;
  transition:all 0.15s;
}
.icon-btn:active { background:var(--ice-glow); }

/* ===== APPLIANCE TABS ===== */
.appliance-tabs {
  display:flex; gap:7px; padding:0 20px 10px; overflow-x:auto;
  flex-shrink:0; scrollbar-width:none;
}
.appliance-tabs::-webkit-scrollbar { display:none; }
.appliance-tab {
  flex-shrink:0; display:flex; align-items:center; gap:6px;
  padding:7px 14px; border-radius:11px;
  background:var(--bg-card); border:1px solid var(--border);
  color:var(--text-secondary); cursor:pointer;
  transition:all 0.2s; user-select:none; font-size:12px; font-weight:500;
}
.appliance-tab .tab-count {
  background:rgba(255,255,255,0.08); border-radius:7px;
  padding:1px 6px; font-size:10px; font-weight:600;
}
.appliance-tab.active-fridge {
  background:linear-gradient(135deg,rgba(102,187,106,0.2),rgba(102,187,106,0.08));
  border-color:rgba(102,187,106,0.4); color:var(--fridge-accent);
}
.appliance-tab.active-freezer {
  background:linear-gradient(135deg,rgba(79,195,247,0.2),rgba(79,195,247,0.08));
  border-color:rgba(79,195,247,0.4); color:var(--freezer-accent);
}
.add-appliance-btn {
  flex-shrink:0; width:34px; height:34px; border-radius:9px;
  background:var(--bg-card); border:1px dashed var(--border);
  color:var(--text-muted); display:flex; align-items:center;
  justify-content:center; cursor:pointer; font-size:16px;
}
.add-appliance-btn:active { background:var(--ice-glow); color:var(--frost-1); }

/* ===== SEARCH ===== */
.search-wrap { padding:0 20px 10px; flex-shrink:0; }
.search-bar {
  display:flex; align-items:center; gap:10px;
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius-sm); padding:9px 14px;
}
.search-bar:focus-within { border-color:var(--frost-1); }
.search-bar svg { flex-shrink:0; color:var(--text-muted); }
.search-bar input {
  flex:1; border:none; background:none; outline:none;
  color:var(--text-primary); font-family:var(--font-body); font-size:14px;
}
.search-bar input::placeholder { color:var(--text-muted); }

/* ===== FILTERS ===== */
.filters {
  display:flex; gap:7px; padding:0 20px 10px; overflow-x:auto;
  flex-shrink:0; scrollbar-width:none;
}
.filters::-webkit-scrollbar { display:none; }
.chip {
  flex-shrink:0; padding:5px 13px; border-radius:20px;
  font-size:11px; font-weight:500; background:var(--bg-card);
  border:1px solid var(--border); color:var(--text-secondary);
  cursor:pointer; transition:all 0.2s; user-select:none;
}
.chip.active {
  background:linear-gradient(135deg,var(--frost-1),#29b6f6);
  border-color:transparent; color:var(--bg-deep);
}

/* ===== LIST ===== */
.list-container {
  flex:1; overflow-y:auto; padding:0 20px 100px;
  -webkit-overflow-scrolling:touch;
}
.list-container::-webkit-scrollbar { width:3px; }
.list-container::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

.empty-state {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; padding:50px 20px; text-align:center;
}
.empty-state .icon { font-size:52px; margin-bottom:12px; opacity:0.6; }
.empty-state h3 { font-family:var(--font-display); font-size:17px; margin-bottom:6px; color:var(--frost-2); }
.empty-state p { color:var(--text-muted); font-size:12px; line-height:1.5; }

.loading-state {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; padding:60px 20px;
}
.spinner {
  width:36px; height:36px; border:3px solid var(--border);
  border-top-color:var(--frost-1); border-radius:50%;
  animation:spin 0.8s linear infinite; margin-bottom:12px;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* ===== ITEM CARD ===== */
.item-card {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:12px; margin-bottom:10px;
  display:flex; gap:11px; transition:all 0.2s;
  animation:slideIn 0.3s ease-out; position:relative; overflow:hidden;
}
.item-card::before {
  content:''; position:absolute; left:0; top:0; bottom:0;
  width:3px; border-radius:0 3px 3px 0;
}
.item-card.status-ok::before { background:var(--success); }
.item-card.status-warning::before { background:var(--warning); }
.item-card.status-danger::before { background:var(--danger); }
.item-photo {
  width:54px; height:54px; border-radius:var(--radius-sm);
  object-fit:cover; flex-shrink:0; background:var(--bg-deep);
  border:1px solid var(--border);
}
.item-photo-placeholder {
  width:54px; height:54px; border-radius:var(--radius-sm);
  flex-shrink:0; display:flex; align-items:center; justify-content:center;
  background:var(--bg-deep); border:1px solid var(--border); font-size:24px;
}
.item-info { flex:1; min-width:0; }
.item-name {
  font-weight:700; font-size:13px; margin-bottom:3px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.item-meta { display:flex; flex-wrap:wrap; gap:4px 8px; font-size:10px; color:var(--text-secondary); }
.item-meta span { display:flex; align-items:center; gap:3px; }
.item-actions { display:flex; flex-direction:column; gap:4px; flex-shrink:0; align-items:flex-end; }
.qty-controls { display:flex; align-items:center; gap:2px; }
.qty-btn {
  width:27px; height:27px; border-radius:7px; border:1px solid var(--border);
  background:var(--bg-deep); color:var(--frost-1); font-size:14px;
  font-weight:700; display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:all 0.15s;
}
.qty-btn:active { background:var(--ice-glow); transform:scale(0.92); }
.qty-value { min-width:28px; text-align:center; font-weight:700; font-size:13px; }
.weight-btn {
  background:none; border:1px solid var(--border); border-radius:6px;
  padding:2px 7px; color:var(--text-secondary); cursor:pointer;
  font-size:10px; font-family:var(--font-body); transition:all 0.15s;
}
.weight-btn:active { background:var(--ice-glow); color:var(--frost-1); }
.delete-btn {
  background:none; border:none; color:var(--text-muted);
  cursor:pointer; padding:2px; font-size:10px;
}
.delete-btn:active { color:var(--danger); }

.expiry-badge {
  display:inline-flex; align-items:center; gap:3px;
  padding:2px 6px; border-radius:5px; font-size:10px; font-weight:600;
}
.expiry-badge.ok { background:rgba(102,187,106,0.15); color:var(--success); }
.expiry-badge.warning { background:rgba(255,183,77,0.15); color:var(--warning); }
.expiry-badge.danger { background:rgba(239,83,80,0.15); color:var(--danger); }
.weight-tag {
  display:inline-flex; align-items:center; padding:2px 6px;
  border-radius:5px; font-size:10px; font-weight:600;
  background:rgba(79,195,247,0.1); color:var(--frost-2);
}
.weight-bar-wrap { margin-top:3px; }
.weight-bar { height:3px; border-radius:2px; background:rgba(79,195,247,0.1); overflow:hidden; }
.weight-bar-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--frost-1),var(--frost-2)); transition:width 0.3s; }
.weight-text { font-size:9px; color:var(--text-muted); margin-top:1px; }

/* ===== FAB ===== */
.fab {
  position:fixed; bottom:26px; left:50%; transform:translateX(-50%);
  width:54px; height:54px; border-radius:50%;
  background:linear-gradient(135deg,var(--frost-1),#0288d1);
  border:none; color:white; font-size:24px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; z-index:100;
  box-shadow:0 4px 20px rgba(79,195,247,0.4); transition:all 0.2s;
}
.fab:active { transform:translateX(-50%) scale(0.92); }

/* ===== MODALS ===== */
.modal-overlay {
  position:fixed; inset:0; z-index:200;
  background:rgba(0,0,0,0.6); backdrop-filter:blur(8px);
  display:flex; align-items:flex-end; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity 0.25s;
}
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal {
  width:100%; max-width:520px; background:var(--bg-card);
  border-radius:24px 24px 0 0; padding:16px 20px 32px;
  transform:translateY(100%);
  transition:transform 0.3s cubic-bezier(0.32,0.72,0,1);
  max-height:92vh; overflow-y:auto;
}
.modal-overlay.open .modal { transform:translateY(0); }
.modal-handle { width:36px; height:4px; border-radius:2px; background:var(--text-muted); margin:0 auto 16px; }
.modal h2 {
  font-family:var(--font-display); font-size:20px; margin-bottom:16px;
  background:linear-gradient(135deg,var(--frost-1),var(--frost-3));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}

/* ===== FORM ===== */
.form-group { margin-bottom:12px; }
.form-label {
  display:block; font-size:10px; font-weight:500; color:var(--text-secondary);
  margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;
}
.form-input {
  width:100%; padding:10px 12px; background:var(--bg-deep);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  color:var(--text-primary); font-family:var(--font-body); font-size:14px;
  outline:none; transition:border-color 0.2s;
}
.form-input:focus { border-color:var(--frost-1); }
.form-row { display:flex; gap:10px; }
.form-row .form-group { flex:1; }
.form-row-3 { display:flex; gap:8px; }
.form-row-3 .form-group { flex:1; }
.form-select {
  width:100%; padding:10px 12px; background:var(--bg-deep);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  color:var(--text-primary); font-family:var(--font-body); font-size:14px;
  outline:none; appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237da8c9' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 12px center;
}
.form-select option { background:var(--bg-card); color:var(--text-primary); }
.photo-area {
  border:2px dashed var(--border); border-radius:var(--radius);
  padding:14px; text-align:center; cursor:pointer;
  min-height:90px; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:5px;
}
.photo-area:active { border-color:var(--frost-1); background:var(--ice-glow); }
.photo-area svg { color:var(--text-muted); }
.photo-area p { font-size:11px; color:var(--text-muted); }
.photo-area img { max-width:100%; max-height:120px; border-radius:var(--radius-sm); object-fit:contain; }
.scan-btn {
  width:100%; padding:9px; border-radius:var(--radius-sm);
  background:var(--bg-deep); border:1px solid var(--border);
  color:var(--frost-1); font-family:var(--font-body); font-size:12px;
  font-weight:500; display:flex; align-items:center; justify-content:center;
  gap:7px; cursor:pointer;
}
.scan-btn:active { background:var(--ice-glow); }
.submit-btn {
  width:100%; padding:12px; border:none; border-radius:var(--radius-sm);
  background:linear-gradient(135deg,var(--frost-1),#0288d1);
  color:white; font-family:var(--font-body); font-size:14px;
  font-weight:700; cursor:pointer; margin-top:4px;
}
.submit-btn:active { transform:scale(0.98); }
.submit-btn:disabled { opacity:0.5; }

/* ===== SCANNER ===== */
.scanner-overlay {
  position:fixed; inset:0; z-index:300; background:#000;
  display:none; flex-direction:column;
}
.scanner-overlay.active { display:flex; }
.scanner-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 20px; background:rgba(0,0,0,0.8); z-index:2;
}
.scanner-header h3 { color:white; font-size:14px; }
.scanner-close { background:none; border:none; color:white; font-size:24px; cursor:pointer; }
#scanner-viewport { flex:1; position:relative; overflow:hidden; }
#scanner-viewport video { width:100%; height:100%; object-fit:cover; }
.scanner-guide {
  position:absolute; inset:0; z-index:1; display:flex;
  align-items:center; justify-content:center; pointer-events:none;
}
.scanner-guide .frame {
  width:240px; height:150px; border:2px solid var(--frost-1);
  border-radius:12px; box-shadow:0 0 0 2000px rgba(0,0,0,0.5); position:relative;
}
.scanner-guide .frame::after {
  content:'Inquadra il codice a barre'; position:absolute;
  bottom:-30px; left:50%; transform:translateX(-50%);
  white-space:nowrap; color:var(--frost-2); font-size:11px;
}
.scanner-guide .line {
  position:absolute; left:10px; right:10px; height:2px;
  background:var(--frost-1); top:50%; animation:scanLine 2s ease-in-out infinite;
  box-shadow:0 0 8px var(--frost-1);
}
@keyframes scanLine { 0%,100%{top:20%} 50%{top:80%} }

/* ===== DIALOGS ===== */
.dialog-overlay {
  position:fixed; inset:0; z-index:250; background:rgba(0,0,0,0.6);
  backdrop-filter:blur(8px); display:flex; align-items:center;
  justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s;
}
.dialog-overlay.open { opacity:1; pointer-events:all; }
.dialog-box {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:22px; width:90%; max-width:320px; text-align:center;
}
.dialog-box h3 { font-family:var(--font-display); font-size:16px; margin-bottom:8px; }
.dialog-box p { font-size:12px; color:var(--text-secondary); margin-bottom:14px; }
.dialog-actions { display:flex; gap:10px; }
.dialog-actions button {
  flex:1; padding:10px; border-radius:var(--radius-sm);
  font-family:var(--font-body); font-size:12px; font-weight:600; cursor:pointer;
}
.btn-cancel { background:var(--bg-deep); border:1px solid var(--border); color:var(--text-secondary); }
.btn-danger { background:var(--danger); border:none; color:white; }
.btn-primary { background:linear-gradient(135deg,var(--frost-1),#0288d1); border:none; color:white; }
.dialog-input {
  width:100%; padding:10px; margin-bottom:12px; background:var(--bg-deep);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  color:var(--text-primary); font-family:var(--font-body); font-size:14px;
  outline:none; text-align:center;
}
.dialog-input:focus { border-color:var(--frost-1); }
.dialog-hint { font-size:11px; color:var(--text-muted); margin-bottom:12px; }

/* ===== DETAIL ===== */
.detail-overlay {
  position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.6);
  backdrop-filter:blur(8px); display:flex; align-items:flex-end;
  justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.25s;
}
.detail-overlay.open { opacity:1; pointer-events:all; }
.detail-modal {
  width:100%; max-width:520px; background:var(--bg-card);
  border-radius:24px 24px 0 0; padding:16px 20px 32px;
  transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.32,0.72,0,1);
  max-height:80vh; overflow-y:auto;
}
.detail-overlay.open .detail-modal { transform:translateY(0); }
.detail-photo {
  width:100%; max-height:160px; object-fit:contain;
  border-radius:var(--radius); margin-bottom:12px; background:var(--bg-deep);
}
.detail-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:8px 12px; background:var(--bg-deep); border-radius:9px; margin-bottom:7px;
}
.detail-row .label { color:var(--text-secondary); font-size:12px; }
.detail-row .value { font-weight:700; font-size:13px; }

/* ===== APPLIANCE TYPE GRID ===== */
.appliance-type-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px; }
.appliance-type-option {
  padding:12px; border-radius:var(--radius-sm); background:var(--bg-deep);
  border:2px solid var(--border); text-align:center; cursor:pointer;
}
.appliance-type-option.sel-fridge { border-color:var(--fridge-accent); background:rgba(102,187,106,0.08); }
.appliance-type-option.sel-freezer { border-color:var(--freezer-accent); background:rgba(79,195,247,0.08); }
.appliance-type-option .atype-icon { font-size:26px; margin-bottom:4px; }
.appliance-type-option .atype-label { font-size:12px; font-weight:600; }

/* ===== TOAST ===== */
.toast {
  position:fixed; top:14px; left:50%; transform:translateX(-50%) translateY(-120%);
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius-sm); padding:9px 16px; font-size:12px;
  color:var(--text-primary); z-index:400; box-shadow:var(--shadow);
  transition:transform 0.3s cubic-bezier(0.32,0.72,0,1); max-width:88%;
}
.toast.show { transform:translateX(-50%) translateY(0); }

/* ===== USER MENU ===== */
.user-menu {
  position:fixed; top:56px; right:20px; z-index:210;
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:8px; min-width:180px;
  box-shadow:var(--shadow); opacity:0; pointer-events:none;
  transform:translateY(-8px); transition:all 0.2s;
}
.user-menu.open { opacity:1; pointer-events:all; transform:translateY(0); }
.user-menu-item {
  display:flex; align-items:center; gap:8px;
  padding:9px 12px; border-radius:8px; font-size:13px;
  color:var(--text-secondary); cursor:pointer; transition:background 0.15s;
}
.user-menu-item:active { background:var(--ice-glow); }
.user-menu-email {
  padding:8px 12px 10px; font-size:11px; color:var(--text-muted);
  border-bottom:1px solid var(--border); margin-bottom:4px;
  overflow:hidden; text-overflow:ellipsis;
}

@keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body>
<div class="frost-bg"></div>

<!-- ===== AUTH SCREEN ===== -->
<div class="auth-screen" id="authScreen">
  <div class="auth-card">
    <div class="logo">‚ùÑÔ∏è</div>
    <h1>FreezeTrack</h1>
    <p class="subtitle">Gestisci i tuoi congelatori e frigoriferi</p>
    <div class="auth-error" id="authError"></div>
    <div class="auth-success" id="authSuccess"></div>
    <input class="auth-input" type="email" id="authEmail" placeholder="Email" autocomplete="email">
    <input class="auth-input" type="password" id="authPassword" placeholder="Password" autocomplete="current-password">
    <button class="auth-btn" id="authBtn" onclick="handleAuth()">Accedi</button>
    <div class="auth-toggle">
      <span id="authToggleText">Non hai un account?</span>
      <a id="authToggleLink" href="javascript:void(0)" onclick="toggleAuthMode()">Registrati</a>
    </div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div class="app" id="app" style="display:none">
  <header class="header">
    <div class="header-left">
      <h1>‚ùÑÔ∏è FreezeTrack</h1>
      <div class="sync-dot" id="syncDot" title="Stato sincronizzazione"></div>
    </div>
    <div class="header-right">
      <span class="count-badge" id="countBadge">0</span>
      <button class="icon-btn" onclick="openAddApplianceModal()">+</button>
      <button class="icon-btn" id="userMenuBtn" onclick="toggleUserMenu()">üë§</button>
    </div>
  </header>

  <div class="user-menu" id="userMenu">
    <div class="user-menu-email" id="userEmail"></div>
    <div class="user-menu-item" onclick="handleLogout()">üö™ Esci</div>
  </div>

  <div class="appliance-tabs" id="applianceTabs"></div>

  <div class="search-wrap">
    <div class="search-bar">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="searchInput" placeholder="Cerca prodotto...">
    </div>
  </div>

  <div class="filters">
    <div class="chip active" data-filter="all">Tutti</div>
    <div class="chip" data-filter="ok">‚úì OK</div>
    <div class="chip" data-filter="expiring">‚ö† In scadenza</div>
    <div class="chip" data-filter="expired">‚úï Scaduti</div>
  </div>

  <div class="list-container" id="listContainer">
    <div class="loading-state"><div class="spinner"></div><p style="color:var(--text-muted);font-size:13px">Caricamento...</p></div>
  </div>
  <button class="fab" id="fabAdd" onclick="openAddModal()">+</button>
</div>

<!-- ===== ADD ITEM MODAL ===== -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="addModalTitle">Aggiungi prodotto</h2>
    <div class="form-group">
      <label class="form-label">Scansiona codice a barre</label>
      <button class="scan-btn" id="scanBarcodeBtn" onclick="startScanner()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 012-2h2m10 0h2a2 2 0 012 2v2m0 10v2a2 2 0 01-2 2h-2M5 21H3a2 2 0 01-2-2v-2"/><line x1="7" y1="8" x2="7" y2="16"/><line x1="11" y1="8" x2="11" y2="16"/><line x1="15" y1="8" x2="15" y2="16"/></svg>
        Scansiona barcode
      </button>
      <div id="barcodeResult" style="margin-top:4px;font-size:10px;color:var(--frost-2);font-family:monospace"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Destinazione</label>
      <select class="form-select" id="inputAppliance"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Nome prodotto *</label>
      <input class="form-input" type="text" id="inputName" placeholder="es. Pizza margherita">
    </div>
    <div class="form-row-3">
      <div class="form-group">
        <label class="form-label">Quantit√†</label>
        <input class="form-input" type="number" id="inputQty" value="1" min="1">
      </div>
      <div class="form-group">
        <label class="form-label">Peso (g)</label>
        <input class="form-input" type="number" id="inputWeight" placeholder="500" min="0">
      </div>
      <div class="form-group">
        <label class="form-label">Scadenza</label>
        <input class="form-input" type="date" id="inputExpiry">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Foto</label>
      <div class="photo-area" id="photoArea" onclick="document.getElementById('photoInput').click()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        <p>Tocca per scattare foto</p>
      </div>
      <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
    </div>
    <button class="submit-btn" id="submitBtn" onclick="submitItem()">Aggiungi</button>
  </div>
</div>

<!-- ===== ADD APPLIANCE MODAL ===== -->
<div class="modal-overlay" id="addApplianceModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>Nuovo elettrodomestico</h2>
    <div class="appliance-type-grid">
      <div class="appliance-type-option sel-freezer" data-type="freezer" onclick="selAppType('freezer')">
        <div class="atype-icon">üßä</div><div class="atype-label">Congelatore</div>
      </div>
      <div class="appliance-type-option" data-type="fridge" onclick="selAppType('fridge')">
        <div class="atype-icon">ü•ó</div><div class="atype-label">Frigorifero</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Nome (opzionale)</label>
      <input class="form-input" type="text" id="inputAppName" placeholder="es. Congelatore garage">
    </div>
    <button class="submit-btn" onclick="submitAppliance()">Aggiungi</button>
  </div>
</div>

<!-- ===== WEIGHT DIALOG ===== -->
<div class="dialog-overlay" id="weightDialog">
  <div class="dialog-box">
    <h3>‚öñÔ∏è Scala peso</h3>
    <p id="weightDialogDesc"></p>
    <input class="dialog-input" type="number" id="weightDialogInput" min="1" placeholder="Grammi utilizzati">
    <div class="dialog-hint" id="weightDialogHint"></div>
    <div class="dialog-actions">
      <button class="btn-cancel" onclick="closeDialog('weightDialog')">Annulla</button>
      <button class="btn-primary" onclick="confirmWeight()">Scala</button>
    </div>
  </div>
</div>

<!-- ===== CONFIRM DELETE ===== -->
<div class="dialog-overlay" id="confirmDialog">
  <div class="dialog-box">
    <h3>üóë Rimuovere?</h3>
    <p id="confirmText"></p>
    <div class="dialog-actions">
      <button class="btn-cancel" onclick="closeDialog('confirmDialog')">Annulla</button>
      <button class="btn-danger" onclick="confirmDelete()">Elimina</button>
    </div>
  </div>
</div>

<!-- ===== CONFIRM DELETE APPLIANCE ===== -->
<div class="dialog-overlay" id="confirmAppDialog">
  <div class="dialog-box">
    <h3>üóë Rimuovere elettrodomestico?</h3>
    <p id="confirmAppText"></p>
    <div class="dialog-actions">
      <button class="btn-cancel" onclick="closeDialog('confirmAppDialog')">Annulla</button>
      <button class="btn-danger" onclick="confirmDeleteAppliance()">Elimina</button>
    </div>
  </div>
</div>

<!-- ===== DETAIL ===== -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-modal" id="detailModal"></div>
</div>

<!-- ===== SCANNER ===== -->
<div class="scanner-overlay" id="scannerOverlay">
  <div class="scanner-header">
    <h3>Scansione barcode</h3>
    <button class="scanner-close" onclick="stopScanner()">‚úï</button>
  </div>
  <div id="scanner-viewport">
    <div class="scanner-guide"><div class="frame"><div class="line"></div></div></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// =============================================================
// =================== CONFIGURAZIONE SUPABASE =================
// =============================================================
// üëá SOSTITUISCI con i tuoi valori da Supabase Dashboard ‚Üí Settings ‚Üí API
const SUPABASE_URL = 'https://jiinpzffsksjhghokkpj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppaW5wemZmc2tzamhnaG9ra3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjA5NzQsImV4cCI6MjA4NjEzNjk3NH0.562Alvk9BCbWC9m-URuonR6FkrrfQiVAXrcnvPQT_rY';
// =============================================================

// Validazione configurazione
const isConfigured = SUPABASE_URL !== 'https://YOUR_PROJECT_ID.supabase.co' && SUPABASE_ANON_KEY !== 'YOUR_ANON_KEY';

let sb = null;
try {
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} catch(e) {
  console.error('Errore creazione client Supabase:', e);
}

if (!isConfigured) {
  document.addEventListener('DOMContentLoaded', () => {
    const errEl = document.getElementById('authError');
    if (errEl) {
      errEl.textContent = '‚ö†Ô∏è Configura SUPABASE_URL e SUPABASE_ANON_KEY in index.html (vedi SETUP_GUIDA.md)';
      errEl.classList.add('show');
    }
  });
}

let currentUser = null;
let appliances = [];
let items = [];
let activeApplianceId = null;
let currentFilter = 'all';
let searchQuery = '';
let deleteTargetId = null;
let deleteAppTargetId = null;
let weightTargetId = null;
let currentBarcode = '';
let currentPhotoData = '';
let newAppType = 'freezer';

// =================== UTILS ===================
function toast(msg, dur=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}
function escHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function formatDate(d) {
  if(!d) return 'N/D';
  return new Date(d+'T00:00:00').toLocaleDateString('it-IT',{day:'numeric',month:'short',year:'numeric'});
}
function daysUntil(d) {
  if(!d) return Infinity;
  const now=new Date(); now.setHours(0,0,0,0);
  return Math.ceil((new Date(d+'T00:00:00')-now)/864e5);
}
function expiryStatus(d) { const days=daysUntil(d); if(days<0) return 'danger'; if(days<=7) return 'warning'; return 'ok'; }
function expiryLabel(d) {
  const days=daysUntil(d); if(!d) return '';
  if(days<0) return `Scaduto ${Math.abs(days)}g fa`;
  if(days===0) return 'Scade oggi!'; if(days===1) return 'Domani';
  if(days<=7) return `Tra ${days}g`; return formatDate(d);
}
function formatWeight(g) { return g>=1000 ? (g/1000).toFixed(g%1000===0?0:1)+' kg' : g+' g'; }
function foodEmoji(n) {
  n=(n||'').toLowerCase();
  const m=[[['pizza'],'üçï'],[['carne','manzo','bistecca','hamburger'],'ü•©'],[['pollo'],'üçó'],[['pesce','salmone','tonno'],'üêü'],[['verdur','spinac','broccol'],'ü•¶'],[['gelato'],'üç¶'],[['pane'],'üçû'],[['past','lasagn','ravioli'],'üçù'],[['zupp','brod','minestra'],'üç≤'],[['patatin'],'üçü'],[['latte','formaggio','mozzarella','yogurt'],'üßÄ'],[['uov'],'ü•ö'],[['torta','dolce'],'üç∞']];
  for(const[k,e] of m) if(k.some(x=>n.includes(x))) return e;
  return 'üì¶';
}
function setSyncStatus(s) { const d=document.getElementById('syncDot'); d.className='sync-dot '+s; }
function closeDialog(id) { document.getElementById(id).classList.remove('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// =================== AUTH ===================
let isLogin = true;
function toggleAuthMode() {
  isLogin = !isLogin;
  document.getElementById('authBtn').textContent = isLogin ? 'Accedi' : 'Registrati';
  document.getElementById('authToggleText').textContent = isLogin ? 'Non hai un account?' : 'Hai gi√† un account?';
  document.getElementById('authToggleLink').textContent = isLogin ? 'Registrati' : 'Accedi';
  document.getElementById('authError').classList.remove('show');
  document.getElementById('authSuccess').classList.remove('show');
}

async function handleAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const errEl = document.getElementById('authError');
  const sucEl = document.getElementById('authSuccess');
  errEl.classList.remove('show'); sucEl.classList.remove('show');

  if (!isConfigured) {
    errEl.textContent = '‚ö†Ô∏è Configura SUPABASE_URL e SUPABASE_ANON_KEY in index.html';
    errEl.classList.add('show'); return;
  }
  if (!sb) {
    errEl.textContent = '‚ö†Ô∏è Errore connessione a Supabase. Controlla URL e chiave API.';
    errEl.classList.add('show'); return;
  }
  if (!email || !password) { errEl.textContent='Compila tutti i campi'; errEl.classList.add('show'); return; }
  if (password.length < 6) { errEl.textContent='La password deve avere almeno 6 caratteri'; errEl.classList.add('show'); return; }

  const btn = document.getElementById('authBtn');
  btn.disabled = true;
  btn.textContent = isLogin ? 'Accesso...' : 'Registrazione...';

  try {
    let result;
    if (isLogin) {
      result = await sb.auth.signInWithPassword({ email, password });
    } else {
      result = await sb.auth.signUp({ email, password });
    }
    if (result.error) throw result.error;
    if (!isLogin && !result.data.session) {
      sucEl.textContent = 'Registrazione completata! Controlla la tua email per confermare.';
      sucEl.classList.add('show');
    }
  } catch (e) {
    console.error('Auth error:', e);
    const msg = e.message || String(e);
    const translations = {
      'Invalid login credentials': 'Credenziali non valide',
      'User already registered': 'Utente gi√† registrato',
      'Password should be at least 6 characters': 'La password deve avere almeno 6 caratteri',
      'Email not confirmed': 'Conferma la tua email prima di accedere',
      'Failed to fetch': 'Errore di rete. Controlla la connessione e le chiavi Supabase.',
      'Invalid API key': 'Chiave API non valida. Controlla SUPABASE_ANON_KEY.',
    };
    errEl.textContent = translations[msg] || msg;
    errEl.classList.add('show');
  }
  btn.disabled = false;
  btn.textContent = isLogin ? 'Accedi' : 'Registrati';
}

async function handleLogout() {
  toggleUserMenu();
  await sb.auth.signOut();
  currentUser = null;
  appliances = []; items = [];
  document.getElementById('app').style.display = 'none';
  document.getElementById('authScreen').classList.remove('hidden');
}

function toggleUserMenu() {
  document.getElementById('userMenu').classList.toggle('open');
}

// Close user menu on outside click
document.addEventListener('click', (e) => {
  const menu = document.getElementById('userMenu');
  const btn = document.getElementById('userMenuBtn');
  if (menu.classList.contains('open') && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.classList.remove('open');
  }
});

// =================== SESSION ===================
if (sb) {
  sb.auth.onAuthStateChange(async (event, session) => {
    if (session?.user) {
      currentUser = session.user;
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('app').style.display = 'flex';
      document.getElementById('userEmail').textContent = currentUser.email;
      await loadData();
      setupRealtime();
    } else {
      currentUser = null;
      document.getElementById('app').style.display = 'none';
      document.getElementById('authScreen').classList.remove('hidden');
    }
  });
}

// =================== DATA LOADING ===================
async function loadData() {
  setSyncStatus('syncing');
  try {
    const [aRes, iRes] = await Promise.all([
      sb.from('appliances').select('*').order('created_at'),
      sb.from('items').select('*').order('created_at')
    ]);
    if (aRes.error) throw aRes.error;
    if (iRes.error) throw iRes.error;

    appliances = aRes.data;
    items = iRes.data;

    // Create defaults if empty
    if (appliances.length === 0) {
      const defaults = [
        { user_id: currentUser.id, type:'fridge', name:'Frigorifero', icon:'ü•ó' },
        { user_id: currentUser.id, type:'freezer', name:'Congelatore', icon:'üßä' }
      ];
      const { data, error } = await sb.from('appliances').insert(defaults).select();
      if (!error) appliances = data;
    }

    activeApplianceId = appliances[0]?.id || null;
    renderTabs();
    renderList();
    setSyncStatus('online');
  } catch (e) {
    console.error('Load error:', e);
    setSyncStatus('offline');
    toast('Errore di caricamento');
  }
}

// =================== REALTIME ===================
function setupRealtime() {
  sb.channel('db-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'items', filter: `user_id=eq.${currentUser.id}` }, (payload) => {
      handleItemChange(payload);
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'appliances', filter: `user_id=eq.${currentUser.id}` }, (payload) => {
      handleApplianceChange(payload);
    })
    .subscribe((status) => {
      setSyncStatus(status === 'SUBSCRIBED' ? 'online' : 'syncing');
    });
}

function handleItemChange(payload) {
  if (payload.eventType === 'INSERT') {
    if (!items.find(i => i.id === payload.new.id)) items.push(payload.new);
  } else if (payload.eventType === 'UPDATE') {
    const idx = items.findIndex(i => i.id === payload.new.id);
    if (idx >= 0) items[idx] = payload.new;
  } else if (payload.eventType === 'DELETE') {
    items = items.filter(i => i.id !== payload.old.id);
  }
  renderList(); renderTabs();
}

function handleApplianceChange(payload) {
  if (payload.eventType === 'INSERT') {
    if (!appliances.find(a => a.id === payload.new.id)) appliances.push(payload.new);
  } else if (payload.eventType === 'UPDATE') {
    const idx = appliances.findIndex(a => a.id === payload.new.id);
    if (idx >= 0) appliances[idx] = payload.new;
  } else if (payload.eventType === 'DELETE') {
    appliances = appliances.filter(a => a.id !== payload.old.id);
    if (activeApplianceId === payload.old.id) activeApplianceId = appliances[0]?.id;
  }
  renderTabs(); renderList();
}

// =================== APPLIANCES ===================
function itemsIn(aId) { return items.filter(i => i.appliance_id === aId); }
function getApp(id) { return appliances.find(a => a.id === id); }

function renderTabs() {
  document.getElementById('applianceTabs').innerHTML = appliances.map(a => {
    const cnt = itemsIn(a.id).length;
    const active = a.id === activeApplianceId;
    const cls = active ? (a.type==='fridge' ? 'active-fridge' : 'active-freezer') : '';
    return `<div class="appliance-tab ${cls}" onclick="switchApp('${a.id}')" oncontextmenu="event.preventDefault();promptDeleteApp('${a.id}')">
      <span>${a.icon}</span><span>${escHtml(a.name)}</span><span class="tab-count">${cnt}</span>
    </div>`;
  }).join('') + `<button class="add-appliance-btn" onclick="openAddApplianceModal()">+</button>`;
}

function switchApp(id) { activeApplianceId = id; renderTabs(); renderList(); }

function selAppType(t) {
  newAppType = t;
  document.querySelectorAll('.appliance-type-option').forEach(el => {
    el.classList.remove('sel-fridge','sel-freezer');
    if(el.dataset.type===t) el.classList.add(t==='fridge'?'sel-fridge':'sel-freezer');
  });
}

function openAddApplianceModal() {
  newAppType='freezer'; document.getElementById('inputAppName').value='';
  selAppType('freezer');
  document.getElementById('addApplianceModal').classList.add('open');
}

async function submitAppliance() {
  const name = document.getElementById('inputAppName').value.trim();
  const type = newAppType;
  const icon = type==='fridge' ? 'ü•ó' : 'üßä';
  const defName = type==='fridge' ? 'Frigorifero' : 'Congelatore';
  const cnt = appliances.filter(a=>a.type===type).length;
  const finalName = name || (cnt>0 ? `${defName} ${cnt+1}` : defName);

  setSyncStatus('syncing');
  const { data, error } = await sb.from('appliances')
    .insert({ user_id:currentUser.id, type, name:finalName, icon }).select().single();
  if (error) { toast('Errore: '+error.message); setSyncStatus('offline'); return; }
  appliances.push(data);
  closeModal('addApplianceModal');
  renderTabs(); populateAppSelect();
  setSyncStatus('online');
  toast(`${finalName} aggiunto! ${icon}`);
}

function promptDeleteApp(id) {
  const a = getApp(id);
  if (!a || appliances.length <= 1) { toast('Devi avere almeno un elettrodomestico'); return; }
  deleteAppTargetId = id;
  const cnt = itemsIn(id).length;
  document.getElementById('confirmAppText').textContent =
    `Eliminare "${a.name}"?${cnt ? ` Contiene ${cnt} prodott${cnt===1?'o':'i'}.` : ''}`;
  document.getElementById('confirmAppDialog').classList.add('open');
}

async function confirmDeleteAppliance() {
  if (!deleteAppTargetId) return;
  setSyncStatus('syncing');
  // Delete items first, then appliance
  await sb.from('items').delete().eq('appliance_id', deleteAppTargetId);
  const { error } = await sb.from('appliances').delete().eq('id', deleteAppTargetId);
  if (error) { toast('Errore'); setSyncStatus('offline'); return; }
  items = items.filter(i => i.appliance_id !== deleteAppTargetId);
  appliances = appliances.filter(a => a.id !== deleteAppTargetId);
  if (activeApplianceId === deleteAppTargetId) activeApplianceId = appliances[0]?.id;
  deleteAppTargetId = null;
  closeDialog('confirmAppDialog');
  renderTabs(); renderList(); setSyncStatus('online');
  toast('Elettrodomestico rimosso');
}

// =================== LIST RENDERING ===================
function getFiltered() {
  let f = items.filter(i => i.appliance_id === activeApplianceId);
  if (currentFilter==='ok') f=f.filter(i=>expiryStatus(i.expiry)==='ok');
  else if (currentFilter==='expiring') f=f.filter(i=>expiryStatus(i.expiry)==='warning');
  else if (currentFilter==='expired') f=f.filter(i=>expiryStatus(i.expiry)==='danger');
  if (searchQuery) { const q=searchQuery.toLowerCase(); f=f.filter(i=>i.name.toLowerCase().includes(q)||(i.barcode&&i.barcode.includes(q))); }
  f.sort((a,b) => {
    const sa=expiryStatus(a.expiry)==='danger'?0:expiryStatus(a.expiry)==='warning'?1:2;
    const sb=expiryStatus(b.expiry)==='danger'?0:expiryStatus(b.expiry)==='warning'?1:2;
    if(sa!==sb) return sa-sb;
    return (a.expiry||'2099')>(b.expiry||'2099')?1:-1;
  });
  return f;
}

function renderList() {
  const c = document.getElementById('listContainer');
  const filtered = getFiltered();
  const total = itemsIn(activeApplianceId).length;
  const app = getApp(activeApplianceId);
  document.getElementById('countBadge').textContent = `${total}`;

  if (filtered.length === 0) {
    const icon = app?.type==='fridge' ? 'ü•ó' : '‚ùÑÔ∏è';
    c.innerHTML = `<div class="empty-state">
      <div class="icon">${total===0?icon:'üîç'}</div>
      <h3>${total===0?(app?.name||'')+' vuoto':'Nessun risultato'}</h3>
      <p>${total===0?'Tocca + per aggiungere':'Prova a cambiare filtri o ricerca'}</p>
    </div>`;
    return;
  }

  c.innerHTML = filtered.map(item => {
    const st = expiryStatus(item.expiry);
    const em = foodEmoji(item.name);
    const hw = item.weight && item.weight > 0;
    const wp = hw && item.original_weight ? Math.round((item.weight/item.original_weight)*100) : 100;
    return `<div class="item-card status-${st}" onclick="showDetail('${item.id}')">
      ${item.photo ? `<img class="item-photo" src="${item.photo}" alt="">` : `<div class="item-photo-placeholder">${em}</div>`}
      <div class="item-info">
        <div class="item-name">${escHtml(item.name)}</div>
        <div class="item-meta">
          ${item.expiry?`<span class="expiry-badge ${st}">${expiryLabel(item.expiry)}</span>`:''}
          ${hw?`<span class="weight-tag">‚öñ ${formatWeight(item.weight)}</span>`:''}
          ${item.barcode?`<span style="font-family:monospace;font-size:9px">üì¶ ${item.barcode}</span>`:''}
        </div>
        ${hw?`<div class="weight-bar-wrap"><div class="weight-bar"><div class="weight-bar-fill" style="width:${wp}%"></div></div><div class="weight-text">${formatWeight(item.weight)} / ${formatWeight(item.original_weight)}</div></div>`:''}
      </div>
      <div class="item-actions" onclick="event.stopPropagation()">
        <div class="qty-controls">
          <button class="qty-btn" onclick="changeQty('${item.id}',-1)">‚àí</button>
          <span class="qty-value">${item.qty}</span>
          <button class="qty-btn" onclick="changeQty('${item.id}',1)">+</button>
        </div>
        ${hw?`<button class="weight-btn" onclick="openWeightDialog('${item.id}')">‚öñ Scala</button>`:''}
        <button class="delete-btn" onclick="promptDelete('${item.id}')">üóë Elimina</button>
      </div>
    </div>`;
  }).join('');
}

// =================== ITEM ACTIONS ===================
async function changeQty(id, delta) {
  const item = items.find(i=>i.id===id);
  if (!item) return;
  const newQty = item.qty + delta;
  if (newQty <= 0) { promptDelete(id); return; }
  item.qty = newQty;
  renderList();
  const { error } = await sb.from('items').update({ qty:newQty }).eq('id', id);
  if (error) toast('Errore sync');
}

function promptDelete(id) {
  const item = items.find(i=>i.id===id);
  if (!item) return;
  deleteTargetId = id;
  document.getElementById('confirmText').textContent = `Eliminare "${item.name}"?`;
  document.getElementById('confirmDialog').classList.add('open');
}

async function confirmDelete() {
  if (!deleteTargetId) return;
  const item = items.find(i=>i.id===deleteTargetId);
  items = items.filter(i=>i.id!==deleteTargetId);
  renderList(); renderTabs();
  closeDialog('confirmDialog');
  const { error } = await sb.from('items').delete().eq('id', deleteTargetId);
  deleteTargetId = null;
  if (item) toast(`${item.name} rimosso`);
}

// =================== WEIGHT ===================
function openWeightDialog(id) {
  const item = items.find(i=>i.id===id);
  if (!item) return;
  weightTargetId = id;
  document.getElementById('weightDialogDesc').textContent = item.name;
  document.getElementById('weightDialogHint').textContent = `Disponibile: ${formatWeight(item.weight)}`;
  document.getElementById('weightDialogInput').value = '';
  document.getElementById('weightDialog').classList.add('open');
  setTimeout(()=>document.getElementById('weightDialogInput').focus(),100);
}

async function confirmWeight() {
  if (!weightTargetId) return;
  const item = items.find(i=>i.id===weightTargetId);
  if (!item) return;
  const amt = parseInt(document.getElementById('weightDialogInput').value)||0;
  if (amt<=0) { toast('Inserisci un valore valido'); return; }
  if (amt>item.weight) { toast('Pi√π del peso disponibile'); return; }

  item.weight -= amt;
  let updates = { weight: item.weight };

  if (item.weight <= 0) {
    if (item.qty <= 1) {
      items = items.filter(i=>i.id!==weightTargetId);
      closeDialog('weightDialog');
      renderList(); renderTabs();
      await sb.from('items').delete().eq('id', weightTargetId);
      weightTargetId = null;
      toast(`${item.name} esaurito e rimosso`);
      return;
    } else {
      item.qty -= 1;
      item.weight = item.original_weight;
      updates = { weight: item.weight, qty: item.qty };
      toast(`${item.name}: 1 unit√† usata, rimangono ${item.qty}`);
    }
  } else {
    toast(`${item.name}: -${formatWeight(amt)}, rimangono ${formatWeight(item.weight)}`);
  }

  closeDialog('weightDialog');
  renderList();
  await sb.from('items').update(updates).eq('id', item.id);
  weightTargetId = null;
}

// =================== DETAIL ===================
function showDetail(id) {
  const item = items.find(i=>i.id===id);
  if(!item) return;
  const st=expiryStatus(item.expiry), em=foodEmoji(item.name), app=getApp(item.appliance_id);
  const hw=item.weight&&item.weight>0;
  const wp=hw&&item.original_weight?Math.round((item.weight/item.original_weight)*100):100;
  document.getElementById('detailModal').innerHTML = `
    <div class="modal-handle"></div>
    ${item.photo?`<img class="detail-photo" src="${item.photo}" alt="">`:''}
    <h2 style="font-size:20px;margin-bottom:12px;-webkit-text-fill-color:var(--text-primary)">${em} ${escHtml(item.name)}</h2>
    <div class="detail-row"><span class="label">üìç Posizione</span><span class="value">${app?app.icon+' '+escHtml(app.name):'N/D'}</span></div>
    <div class="detail-row"><span class="label">üì¶ Quantit√†</span><span class="value">${item.qty}</span></div>
    ${hw?`<div class="detail-row"><span class="label">‚öñÔ∏è Peso</span><span class="value">${formatWeight(item.weight)} / ${formatWeight(item.original_weight)}</span></div>
    <div style="padding:0 12px 6px"><div class="weight-bar" style="height:5px"><div class="weight-bar-fill" style="width:${wp}%"></div></div>
    <div style="text-align:center;font-size:11px;color:var(--text-muted);margin-top:3px">${wp}%</div></div>`:''}
    ${item.expiry?`<div class="detail-row"><span class="label">üìÖ Scadenza</span><span class="expiry-badge ${st}">${expiryLabel(item.expiry)}</span></div>`:''}
    ${item.barcode?`<div class="detail-row"><span class="label">üì¶ Barcode</span><span class="value" style="font-family:monospace;font-size:12px">${item.barcode}</span></div>`:''}
    <div class="detail-row"><span class="label">üìÖ Aggiunto</span><span class="value" style="font-size:12px">${formatDate(item.added_date)}</span></div>
  `;
  document.getElementById('detailOverlay').classList.add('open');
}

// =================== ADD ITEM ===================
function populateAppSelect() {
  document.getElementById('inputAppliance').innerHTML = appliances.map(a =>
    `<option value="${a.id}" ${a.id===activeApplianceId?'selected':''}>${a.icon} ${escHtml(a.name)}</option>`
  ).join('');
}

function openAddModal() {
  currentBarcode=''; currentPhotoData='';
  document.getElementById('inputName').value='';
  document.getElementById('inputQty').value='1';
  document.getElementById('inputWeight').value='';
  document.getElementById('inputExpiry').value='';
  document.getElementById('barcodeResult').textContent='';
  document.getElementById('photoArea').innerHTML=`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg><p>Tocca per scattare foto</p>`;
  populateAppSelect();
  const app=getApp(activeApplianceId);
  const label=app?.type==='fridge'?'frigorifero':'congelatore';
  document.getElementById('addModalTitle').textContent=`Aggiungi al ${label}`;
  document.getElementById('addModal').classList.add('open');
}

async function submitItem() {
  const name=document.getElementById('inputName').value.trim();
  const qty=parseInt(document.getElementById('inputQty').value)||1;
  const weight=parseInt(document.getElementById('inputWeight').value)||0;
  const expiry=document.getElementById('inputExpiry').value||null;
  const applianceId=document.getElementById('inputAppliance').value;
  if(!name) { toast('Inserisci il nome'); return; }

  document.getElementById('submitBtn').disabled=true;
  setSyncStatus('syncing');

  const newItem = {
    user_id: currentUser.id,
    appliance_id: applianceId,
    name, qty: Math.max(1,qty),
    weight: weight>0?weight:0,
    original_weight: weight>0?weight:0,
    expiry, barcode: currentBarcode||null,
    photo: currentPhotoData||null,
    added_date: new Date().toISOString().split('T')[0]
  };

  const { data, error } = await sb.from('items').insert(newItem).select().single();
  document.getElementById('submitBtn').disabled=false;
  if (error) { toast('Errore: '+error.message); setSyncStatus('offline'); return; }

  items.push(data);
  activeApplianceId = applianceId;
  closeModal('addModal');
  renderTabs(); renderList();
  setSyncStatus('online');
  toast(`${name} aggiunto!`);
}

// =================== PHOTO ===================
document.getElementById('photoInput').addEventListener('change', (e) => {
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const MAX=400; let w=img.width, h=img.height;
      if(w>h){if(w>MAX){h*=MAX/w;w=MAX;}} else {if(h>MAX){w*=MAX/h;h=MAX;}}
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      currentPhotoData=canvas.toDataURL('image/jpeg',0.6);
      document.getElementById('photoArea').innerHTML=`<img src="${currentPhotoData}" alt="">`;
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
});

// =================== BARCODE ===================
function startScanner() {
  document.getElementById('scannerOverlay').classList.add('active');
  Quagga.init({
    inputStream:{name:"Live",type:"LiveStream",target:document.getElementById('scanner-viewport'),
      constraints:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}},
    decoder:{readers:["ean_reader","ean_8_reader","code_128_reader","code_39_reader","upc_reader","upc_e_reader"]},
    locate:true, frequency:10
  }, (err) => { if(err){toast('Errore fotocamera');stopScanner();return;} Quagga.start(); });
  Quagga.onDetected((r)=>{
    const code=r.codeResult.code;
    if(code){currentBarcode=code; document.getElementById('barcodeResult').textContent=`‚úì ${code}`;
    if(navigator.vibrate)navigator.vibrate(100); toast(`Barcode: ${code}`); stopScanner(); lookupBarcode(code);}
  });
}
function stopScanner() { try{Quagga.stop();}catch{} document.getElementById('scannerOverlay').classList.remove('active'); }

async function lookupBarcode(code) {
  try {
    const res=await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
    const data=await res.json();
    if(data.status===1&&data.product){
      const p=data.product;
      const name=p.product_name_it||p.product_name||'';
      if(name&&!document.getElementById('inputName').value){document.getElementById('inputName').value=name;toast(`Trovato: ${name}`);}
      if(p.quantity){const wm=p.quantity.match(/(\d+)\s*g/i);if(wm&&!document.getElementById('inputWeight').value)document.getElementById('inputWeight').value=wm[1];}
      if(p.image_url&&!currentPhotoData){currentPhotoData=p.image_url;document.getElementById('photoArea').innerHTML=`<img src="${p.image_url}" alt="" crossorigin>`;}
    }
  } catch{}
}

// =================== EVENTS ===================
document.getElementById('searchInput').addEventListener('input',(e)=>{searchQuery=e.target.value;renderList();});
document.querySelectorAll('.chip').forEach(c=>c.addEventListener('click',()=>{
  document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active'); currentFilter=c.dataset.filter; renderList();
}));
['addModal','addApplianceModal','detailOverlay'].forEach(id=>{
  document.getElementById(id).addEventListener('click',(e)=>{if(e.target===e.currentTarget)e.target.classList.remove('open');});
});

// Long-press on appliance tabs for delete
let lpt=null;
document.getElementById('applianceTabs').addEventListener('touchstart',(e)=>{
  const tab=e.target.closest('.appliance-tab');
  if(!tab) return;
  const txt=tab.textContent;
  const a=appliances.find(x=>txt.includes(x.name));
  if(a) lpt=setTimeout(()=>promptDeleteApp(a.id),600);
},{passive:true});
document.getElementById('applianceTabs').addEventListener('touchend',()=>clearTimeout(lpt),{passive:true});
document.getElementById('applianceTabs').addEventListener('touchmove',()=>clearTimeout(lpt),{passive:true});

// Enter key on auth
document.getElementById('authPassword').addEventListener('keydown',(e)=>{if(e.key==='Enter')handleAuth();});

// PWA
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
